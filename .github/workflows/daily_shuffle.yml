name: Ultimate Limbo System

on:
  schedule:
    - cron: '0 0 * * *' # 3:00 –Ω–æ—á–∏ –ø–æ –ú–°–ö
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-limbo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: The Python Brain
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        shell: python
        run: |
          import os
          import random
          import shutil
          import hashlib
          import json
          import datetime
          import requests # –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–µ–±—Ö—É–∫–∞

          KEYS_DIR = "all_keys"
          TARGET_FILE = "current.gif"
          INFO_FILE = "info.json"
          README_FILE = "README.md"

          # --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê (–∏–∑ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏) ---
          all_files = [f for f in os.listdir(KEYS_DIR) if f.endswith('.gif')]
          if not all_files: exit(1)

          current_hash = None
          if os.path.exists(TARGET_FILE):
              with open(TARGET_FILE, "rb") as f: current_hash = hashlib.md5(f.read()).hexdigest()

          candidates = []
          if current_hash:
              for filename in all_files:
                  with open(os.path.join(KEYS_DIR, filename), "rb") as f:
                      if hashlib.md5(f.read()).hexdigest() != current_hash:
                          candidates.append(filename)
          
          if not candidates: candidates = all_files
          new_key = random.choice(candidates)
          
          # --- –î–ï–ô–°–¢–í–ò–Ø ---
          
          # 1. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª
          shutil.copy2(os.path.join(KEYS_DIR, new_key), TARGET_FILE)
          
          # 2. –°–æ–∑–¥–∞–µ–º JSON-–∏–Ω—Ñ–æ (API)
          data = {
              "current_key": new_key,
              "updated_at": datetime.datetime.utcnow().isoformat(),
              "total_keys": len(all_files)
          }
          with open(INFO_FILE, "w") as f:
              json.dump(data, f, indent=2)

          # 3. –û–±–Ω–æ–≤–ª—è–µ–º README (–ë–æ—Ä—å–±–∞ —Å –∫—ç—à–µ–º GitHub)
          # –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∫ —Å—Å—ã–ª–∫–µ, —á—Ç–æ–±—ã GitHub –ø–æ–∫–∞–∑–∞–ª –Ω–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
          md_content = f"""
          # Daily Limbo Key üîë
          
          –ö–ª—é—á –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC.
          
          ### –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –∫–ª—é—á: **{new_key}**
          ![Current Key](current.gif?v={random.randint(1000,9999)})
          """
          with open(README_FILE, "w", encoding="utf-8") as f:
              f.write(md_content)

          # 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Discord (–í–µ–±—Ö—É–∫)
          webhook_url = os.environ.get("DISCORD_WEBHOOK")
          if webhook_url:
              repo_url = f"https://raw.githubusercontent.com/{os.environ.get('GITHUB_REPOSITORY')}/main/current.gif"
              # –¢—Ä—é–∫ —Å –¥–∞—Ç–æ–π –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞ –î–∏—Å–∫–æ—Ä–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
              cache_buster = f"{repo_url}?v={datetime.datetime.now().timestamp()}"
              
              payload = {
                  "username": "Limbo Keeper",
                  "content": f"üîë **–ù–æ–≤—ã–π –∫–ª—é—á –≤—ã–±—Ä–∞–Ω!**\n–°–µ–≥–æ–¥–Ω—è —ç—Ç–æ: `{new_key}`",
                  "embeds": [{
                      "image": {"url": cache_buster},
                      "color": 3066993
                  }]
              }
              try:
                  requests.post(webhook_url, json=payload)
                  print("Webhook sent!")
              except Exception as e:
                  print(f"Webhook failed: {e}")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞
          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
              env_file.write(f"NEW_KEY={new_key}\n")

      - name: Commit Changes
        run: |
          git config user.name "Limbo Bot"
          git config user.email "bot@limbo.local"
          git add current.gif info.json README.md
          git commit -m "üîë Update: ${{ env.NEW_KEY }}" || echo "Nothing to commit"
          git push
