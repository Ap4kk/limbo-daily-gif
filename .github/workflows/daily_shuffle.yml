name: Daily Limbo Shuffle

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  shuffle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0         # full history so pull/rebase/reset work
          persist-credentials: true

      - name: Set branch
        run: |
          echo "BRANCH=main" >> $GITHUB_ENV

      - name: Sync to latest remote main
        run: |
          # Make sure we are on the branch and match remote state before changing files
          git fetch origin $BRANCH
          git checkout $BRANCH
          git reset --hard origin/$BRANCH

      - name: Pick random GIF
        run: |
          RANDOM_FILE=$(ls all_keys/*.gif | shuf -n 1)
          echo "Selected key: $RANDOM_FILE"
          cp "$RANDOM_FILE" current.gif

      - name: Commit and Push
        env:
          BRANCH: ${{ env.BRANCH }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Limbo Bot"
          git config user.email "bot@github.com"

          # Stage and commit only if there are changes
          git add current.gif
          if git diff --quiet --cached; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Daily Limbo Key Update [skip ci]"

          # Ensure we integrate any remote commits that appeared since the reset
          git fetch origin $BRANCH

          # Try to rebase local commit on top of remote to avoid non-fast-forward
          git pull --rebase origin $BRANCH || {
            # If rebase fails, abort and fail the job so manual intervention occurs
            git rebase --abort || true
            echo "Rebase failed. Aborting push to avoid overwriting remote changes."
            exit 1
          }

          # Push commit to remote
          git push origin HEAD:$BRANCH
